- hosts: all
  become: yes
  tasks:

    # Users.
    - name: create the 'mxs' user
      user: name=mxs append=yes state=present createhome=yes shell=/bin/bash
    - name: allow 'mxs' to have passwordless sudo
      lineinfile:
        dest: /etc/sudoers
        line: 'mxs ALL=(ALL) NOPASSWD: ALL'
        validate: 'visudo -cf %s'
    - name: set up authorized keys for the 'mxs' user
      authorized_key: user=mxs key="{{item}}"
      with_file:
        - keys/mxs.pub

    # Common.
    - name: set up classic packages
      apt:
        name:
          - htop
          - weechat
          - irssi
          - tree
          - emacs-nox
          - tmux
          - docker.io
          - apt-transport-https
        state: present

    # Disable swap.
    - name: remove swapfile from /etc/fstab
      mount:
        name: swap
        fstype: swap
        state: absent
    - name: disable swap
      command: swapoff -a
      when: ansible_swaptotal_mb > 0

    # Docker.
    - name: enable docker
      systemd:
        name: docker
        enabled: yes
        state: started

    # Kubernetes.
    - name: add k8s apt key
      apt_key:
        url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
        state: present
    - name: add k8s APT repository
      apt_repository:
        repo: deb http://apt.kubernetes.io/ kubernetes-xenial main
        state: present
        filename: 'k8s'
    - name: set up k8s packages
      apt:
        name:
          - kubelet
          - kubeadm
          - kubectl
        state: present
